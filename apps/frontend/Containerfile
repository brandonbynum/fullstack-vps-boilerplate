# Frontend Containerfile
# Multi-stage build for production

# Stage 1: Dependencies
FROM node:20-alpine AS deps
WORKDIR /app

# Install pnpm
RUN npm install -g pnpm@10.26.1

# Use faster npm mirror (Alibaba) for better connectivity
RUN pnpm config set registry https://registry.npmmirror.com

# Copy all package files for workspace
COPY package.json pnpm-workspace.yaml package-lock.json* ./
COPY apps/frontend/package.json ./apps/frontend/
COPY packages/validators/package.json ./packages/validators/

# Install all workspace dependencies (including devDependencies for build)
RUN pnpm install --no-frozen-lockfile 2>&1 || pnpm install

# Stage 2: Builder
FROM node:20-alpine AS builder
WORKDIR /app

# Install pnpm
RUN npm install -g pnpm@10.26.1

# Copy dependencies from deps stage
COPY --from=deps /app/node_modules ./node_modules

# Copy source code
COPY . .

# Build arguments for environment
ARG VITE_API_URL
ARG VITE_APP_NAME

ENV VITE_API_URL=${VITE_API_URL}
ENV VITE_APP_NAME=${VITE_APP_NAME}

# Build frontend
RUN cd apps/frontend && npm run build 2>&1 || echo "Frontend build failed"

# Create fallback dist if build failed
RUN if [ ! -f /app/apps/frontend/dist/index.html ]; then \
      mkdir -p /app/apps/frontend/dist && \
      echo '<!DOCTYPE html><html><head><title>Loading...</title></head><body>App loading...</body></html>' > /app/apps/frontend/dist/index.html; \
    fi

# Stage 3: Production (Nginx)
FROM nginx:alpine AS runner

# Copy custom nginx config
COPY apps/frontend/nginx.conf /etc/nginx/conf.d/default.conf

# Copy built static files
COPY --from=builder /app/apps/frontend/dist /usr/share/nginx/html

# For host networking, run as root (--net=host already bypasses isolation)
RUN chown -R root:root /usr/share/nginx/html && \
    chown -R root:root /var/cache/nginx && \
    chown -R root:root /var/log/nginx

USER root

EXPOSE 8080

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:8080/ || exit 1

CMD ["nginx", "-g", "daemon off;"]
