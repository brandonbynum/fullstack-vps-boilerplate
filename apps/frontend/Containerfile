# Frontend Containerfile

# Stage 1: Dependencies
FROM node:20-alpine AS deps
WORKDIR /app
RUN npm install -g pnpm@10.26.1
COPY package.json pnpm-lock.yaml* pnpm-workspace.yaml* ./
COPY apps/frontend/package.json ./apps/frontend/
COPY packages/validators/package.json ./packages/validators/
RUN pnpm install --no-frozen-lockfile --prod=false

# Stage 2: Development (Stop here for dev)
FROM node:20-alpine AS dev
WORKDIR /app
RUN npm install -g pnpm@10.26.1
COPY --from=deps /app/node_modules ./node_modules
COPY . .
# Ready for pnpm dev

# Stage 3: Builder
FROM dev AS builder
ARG VITE_API_URL
ARG VITE_APP_NAME
ENV VITE_API_URL=${VITE_API_URL:-""}
ENV VITE_APP_NAME=${VITE_APP_NAME:-"Full-Stack App"}
RUN cd apps/frontend && pnpm exec vite build

# Stage 4: Production
FROM nginx:alpine
WORKDIR /usr/share/nginx/html
COPY apps/frontend/nginx.conf /etc/nginx/conf.d/default.conf
COPY --from=builder /app/apps/frontend/dist .
EXPOSE 8080
# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3     CMD wget --no-verbose --tries=1 --spider http://localhost:8080/ || exit 1
CMD ["nginx", "-g", "daemon off;"]
