name: CD Production

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          DOMAIN: ${{ secrets.DOMAIN }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_REFRESH_SECRET: ${{ secrets.JWT_REFRESH_SECRET }}
          FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
          ALLOWED_ORIGINS: ${{ secrets.ALLOWED_ORIGINS }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
        run: |
          # Rsync project files to VPS
          rsync -avz --delete \
            --exclude 'node_modules' \
            --exclude '.git' \
            --exclude '.env' \
            --exclude '.env.local' \
            --exclude '*.log' \
            ./ $VPS_USER@$VPS_HOST:/opt/fullstack-app/

          # Create .env file on VPS
          ssh $VPS_USER@$VPS_HOST << 'ENVSSH'
          cat > /opt/fullstack-app/.env << 'EOF'
          NODE_ENV=production
          DOMAIN=${DOMAIN}

          # Database
          POSTGRES_USER=${POSTGRES_USER}
          POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
          POSTGRES_DB=${POSTGRES_DB}

          # JWT
          JWT_SECRET=${JWT_SECRET}
          JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
          JWT_EXPIRES_IN=15m
          JWT_REFRESH_EXPIRES_IN=7d
          MAGIC_LINK_EXPIRES_IN=5m

          # URLs
          FRONTEND_URL=${FRONTEND_URL}
          ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
          VITE_API_URL=/api
          VITE_APP_NAME=Full-Stack App

          # Email
          SMTP_HOST=${SMTP_HOST}
          SMTP_PORT=${SMTP_PORT}
          SMTP_USER=${SMTP_USER}
          SMTP_PASSWORD=${SMTP_PASSWORD}
          EMAIL_FROM=${EMAIL_FROM}
          EOF
          ENVSSH

          # Run deployment script
          ssh $VPS_USER@$VPS_HOST 'cd /opt/fullstack-app && ./infrastructure/scripts/deploy.sh'

      - name: Health Check
        run: |
          sleep 30
          curl -f https://${{ secrets.DOMAIN }}/health || exit 1

      - name: Notify Success
        if: success()
        run: echo "Deployment to production successful!"

      - name: Notify Failure
        if: failure()
        run: echo "Deployment to production failed!"
